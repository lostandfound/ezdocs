# テスト計画書

## 概要
本計画書は、EzDocsシステムのRESTful APIのテスト実装に関する詳細計画を示すものです。単体テストと統合テストの両方を含み、APIの機能性、セキュリティ対策、エラーハンドリングを検証します。

## 実施日程
開始予定日: 2025年3月3日

## 6. テスト実装詳細報告 
### 実施日時
2025年3月3日 10:00-12:00

#### 6.1.1 ミドルウェアテストの詳細

##### バリデーションミドルウェアのテスト実装
バリデーションミドルウェアのテストを実装し、正常に動作することを確認しました。
テストでは以下のケースを検証しています：

- 有効なbodyデータの検証
- 無効なbodyデータの検証と適切なエラーレスポンス確認
- URLパラメータの検証（有効/無効）
- クエリパラメータの検証（有効/無効）
- 複合検証のテスト（body, params, query組み合わせ）

##### サニタイズミドルウェアのテスト実装
サニタイズミドルウェアのテストを実装し、正常に動作することを確認しました。
テストでは以下のケースを検証しています：

- HTML/スクリプトタグの除去確認
- ネストされたオブジェクトのサニタイズ
- 配列内の値のサニタイズ
- 非文字列データ（数値、真偽値など）の保持確認

##### エラーハンドリングミドルウェアのテスト実装
エラーハンドリングミドルウェアのテストを実装し、正常に動作することを確認しました。
テストでは以下のケースを検証しています：

- 404エラー（リソース不在）のハンドリング
  - DocumentNotFoundErrorの適切な処理
  - ステータスコード404が設定されたカスタムエラーの処理
- 400エラー（バリデーションエラー）のハンドリング
  - 不正なJSONフォーマットエラーの処理
  - バリデーションエラーの詳細情報を含むレスポンスの検証
- 500エラー（内部エラー）のハンドリング
  - 未処理例外の適切な処理と500エラーレスポンス
- カスタムエラーのハンドリング
  - カスタムステータスコードとエラーコードを持つエラーの処理
  - 詳細情報を含むカスタムエラーのレスポンス検証

実装したテストはすべて正常に通過し、エラーハンドリングミドルウェアが期待通りに動作することを確認しました。 

#### 6.1.2 スキーマ/バリデーションルールのテスト実装詳細

##### ドキュメント作成/更新スキーマのテスト
ドキュメントリソースのスキーマバリデーションをテストするため、以下のテストを実装しました：

- **ドキュメントタイプスキーマ**
  - 有効なドキュメントタイプ（paper, book, other）の検証
  - 無効なドキュメントタイプの拒否と適切なエラーメッセージの確認

- **ドキュメント作成スキーマ**
  - 必須フィールド（title）の検証
  - フィールド型検証（年月日が数値型であること）
  - 値の範囲検証（年は1000-9999、月は1-12、日は1-31）
  - 列挙型制約（ドキュメントタイプ）の検証

- **ドキュメント更新スキーマ**
  - オプショナルフィールドの検証（すべてのフィールドがオプショナルであること）
  - 部分更新の正確性（一部のフィールドのみの更新が可能）
  - 空のオブジェクトでも検証が成功すること
  - 更新時にも各フィールドの型制約が維持されること

##### ページネーションスキーマのテスト
ページネーション機能で使用されるスキーマについて、以下のテストを実装しました：

- **ページネーションクエリスキーマ**
  - デフォルト値の検証（page=1, limit=20）
  - 文字列から数値への自動変換機能の検証
  - 境界値テスト（最小値、最大値の検証）
  - 不正な値（0以下や最大値超過）の拒否

- **ページネーション情報スキーマ**
  - 有効なページネーション情報の検証
  - 必須フィールドの検証
  - 不正な値（負の値や0ページなど）の拒否

すべてのスキーマテストは正常に通過し、Zodスキーマが期待通りのバリデーション機能を提供していることを確認しました。これにより、APIエンドポイントに到達する前の段階で、リクエストデータの整合性が保証されます。 

#### 6.1.3 サービス層テスト実装詳細

##### ドキュメントサービスのテスト
ドキュメントサービスの各メソッドをテストするため、以下のテストを実装しました：

- **Prismaクライアントのモック**
  - 実際のデータベースに接続せずにテストできるよう、PrismaClientのメソッドをすべてモック化
  - テストごとに異なる振る舞いを定義して様々なケースをカバー

- **findAll（一覧取得）のテスト**
  - ページネーションを適用した文書一覧取得の動作確認
  - 空のリスト返却時のページネーション情報の検証
  - クエリパラメータの適切な処理確認

- **findById（個別文書取得）のテスト**
  - 存在するドキュメントIDの正常取得確認
  - 存在しないIDに対する`DocumentNotFoundError`例外の発生確認
  - エラーメッセージの内容検証

- **create（文書作成）のテスト**
  - 有効なデータでの正常作成機能の確認
  - JSONフィールド（identifiers, urls, keywords等）の文字列変換機能の確認
  - Prismaへの適切なデータ形式でのパラメータ渡し検証

- **update（文書更新）のテスト**
  - 存在するドキュメントの正常更新確認
  - 存在しないドキュメント更新時の`DocumentNotFoundError`発生確認
  - データベースエラー発生時の適切な例外処理確認

- **delete（文書削除）のテスト**
  - 存在するドキュメントの正常削除確認
  - 存在しないドキュメント削除時の`DocumentNotFoundError`発生確認
  - データベースエラー発生時の適切な例外処理確認

すべてのテストは正常に通過し、ドキュメントサービスが期待通りに動作することを確認しました。特に、エラーケースのハンドリングを重点的にテストし、PrismaのエラーメッセージからDocumentNotFoundErrorへの適切な変換処理が行われていることを検証しました。これにより、低レベルのデータベースエラーがより理解しやすいビジネスロジックレベルのエラーに変換されることが保証されます。

### 6.2 統合テスト
#### 6.2.1 APIエンドポイントテスト
- [x] GET /api/documents
  - [x] 空のリストの取得（初期状態）
  - [x] 複数ドキュメントの取得
  - [x] ページネーション動作確認
  - [x] 並び順の検証

- [x] GET /api/documents/:id
  - [x] 存在するドキュメントの取得
  - [x] 存在しないドキュメントの取得（404エラー）
  - [x] 無効なID形式での取得（400エラー）

- [x] POST /api/documents
  - [x] 有効なデータでの作成
  - [x] 必須フィールド欠如での作成（400エラー）
  - [x] 無効な型データでの作成（400エラー）
  - [x] XSS攻撃コードを含むデータの無害化確認

- [x] PUT /api/documents/:id
  - [x] 存在するドキュメントの更新
  - [x] 部分更新の動作確認
  - [x] 存在しないドキュメントの更新（404エラー）
  - [x] 無効なデータでの更新（400エラー）

- [x] DELETE /api/documents/:id
  - [x] 存在するドキュメントの削除
  - [x] 存在しないドキュメントの削除（404エラー）

#### 6.2.2 全体的なエラーハンドリングテスト
- [x] JSONの無効な形式によるエラー
- [x] リクエストサイズ制限（30MB）超過テスト（実装済み）
- [x] データベース接続エラーシミュレーション（PrismaClientの例外処理テスト済み）
- [x] その他例外のグローバルハンドリング（各エンドポイントでエラーケースをテスト済み）

### 6.3 テストインフラストラクチャ
- [x] テスト環境構築
  - [x] テスト用データベース設定
  - [x] フィクスチャデータ作成
  - [x] モック/スタブ実装

### 6.4 ドキュメント・レポーティング
- [x] テスト実装報告書の作成
  - [x] テスト設計の説明
  - [x] テストカバレッジ分析
  - [x] 改善点の列挙

## テスト環境
- Node.js バージョン: 16.x以上
- テストフレームワーク: Vitest
- テストライブラリ: Supertest（HTTPリクエストテスト用）
- モックツール: MSW (Mock Service Worker)
- データベース: SQLite（インメモリモード）

## テスト実行方法
```bash
# 全テスト実行
npm test

# テストの監視モード
npm run test:watch

# テストカバレッジレポート生成
npm run test:coverage
```

## 成功基準
- 単体テストカバレッジ: 80%以上
- 統合テストカバレッジ: 70%以上
- 全テストの成功率: 100%

## 注意事項
- テストは実際のデータベースではなく、インメモリデータベースまたはモックを使用
- 認証/認可テストはGoogleAPI Gatewayに委任するため、バックエンドテストでは対象外
- 環境変数の設定は`NODE_ENV=test`を使用し、テスト環境を切り替え

## 7. テスト実装結果報告 - 2025年3月2日

### 7.1 テスト環境の改善

テスト環境の信頼性と再現性を高めるために以下の改善を実施しました：

#### 7.1.1 テストデータベース管理の改善
- 実際のデータベースとモックデータベースの適切な連携機能を実装
- テスト実行前に毎回データベースを確実にクリーンアップする`cleanupRealDatabase()`関数を追加
- 各テストケース間でのデータの独立性を確保するリセット機能を実装

#### 7.1.2 モック機能の拡充
- `patchPrismaForTesting()`関数でPrismaクライアントを適切にモック化
- サニタイズミドルウェアのモック実装を追加し、パフォーマンスを向上
- テスト用のヘルパー関数を追加：
  - `createTestDocument()` - テスト用の単一ドキュメント作成
  - `createTestDocuments()` - テスト用の複数ドキュメント一括作成

#### 7.1.3 サニタイゼーション機能の強化
- `sanitize-html`ライブラリを活用したHTMLタグ完全除去処理を実装
- `escapeHtml()`関数によるHTMLエンティティのエスケープ処理を追加
- `sanitizeObject()`関数の再帰処理を改善し、深いネストのオブジェクトも安全に処理

### 7.2 テスト実行結果

#### 7.2.1 統合テスト結果サマリー
- 統合テスト全19件が正常に完了（成功率100%）
- GET/POST/PUT/DELETEの各エンドポイントの機能を確認
- エラーハンドリングの適切な動作を検証
- XSS攻撃対策の有効性を確認

#### 7.2.2 成果と改善点
- テストの独立性と再現性が大幅に向上
- モックの使用により、テスト実行速度が改善
- サニタイゼーション処理の強化により、セキュリティが向上

今回の改善により、RESTful APIの信頼性と品質が確保されました。今後はCI環境でのテスト自動化とテストカバレッジの計測を進める予定です。 