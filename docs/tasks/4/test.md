# テスト計画書

## 概要
本計画書は、EzDocsシステムのRESTful APIのテスト実装に関する詳細計画を示すものです。単体テストと統合テストの両方を含み、APIの機能性、セキュリティ対策、エラーハンドリングを検証します。

## 実施日程
開始予定日: 2025年3月3日

## 6. テスト実装
### 6.1 単体テスト
#### 6.1.1 ミドルウェアテスト
- [x] バリデーションミドルウェア（validate.ts）のテスト
  - [x] 有効なbodyデータの検証
  - [x] 無効なbodyデータの検証と適切なエラーレスポンス確認
  - [x] URLパラメータの検証（有効/無効）
  - [x] クエリパラメータの検証（有効/無効）
  - [x] 複合検証のテスト（body, params, query組み合わせ）

- [x] サニタイズミドルウェア（sanitize.ts）のテスト
  - [x] HTML/スクリプトタグの除去確認
  - [x] ネストされたオブジェクトのサニタイズ
  - [x] 配列内の値のサニタイズ
  - [x] 非文字列データ（数値、真偽値など）の保持確認

- [x] エラーハンドリングミドルウェアのテスト
  - [x] 404エラー（リソース不在）のハンドリング
  - [x] 400エラー（バリデーションエラー）のハンドリング
  - [x] 500エラー（内部エラー）のハンドリング
  - [x] カスタムエラーのハンドリング

#### 6.1.2 スキーマ/バリデーションルールのテスト
- [x] ドキュメント作成スキーマのテスト
  - [x] 必須フィールド検証
  - [x] フィールド型検証
  - [x] 列挙型制約（ドキュメントタイプなど）

- [x] ドキュメント更新スキーマのテスト
  - [x] オプショナルフィールド検証
  - [x] 部分更新の正確性

- [x] ページネーションスキーマのテスト
  - [x] デフォルト値の検証
  - [x] 境界値テスト（最小値、最大値）

#### 6.1.3 サービス層テスト
- [x] ドキュメントサービスの単体テスト
  - [x] 文書の取得（findById, findAll）
  - [x] 文書の作成
  - [x] 文書の更新
  - [x] 文書の削除
  - [x] ページネーション機能
  - [x] エラーケースのハンドリング

### 6.2 統合テスト
#### 6.2.1 APIエンドポイントテスト
- [x] GET /api/documents
  - [x] 空のリストの取得（初期状態）
  - [x] 複数ドキュメントの取得
  - [x] ページネーション動作確認
  - [x] 並び順の検証

- [x] GET /api/documents/:id
  - [x] 存在するドキュメントの取得
  - [x] 存在しないドキュメントの取得（404エラー）
  - [x] 無効なID形式での取得（400エラー）

- [x] POST /api/documents
  - [x] 有効なデータでの作成
  - [x] 必須フィールド欠如での作成（400エラー）
  - [x] 無効な型データでの作成（400エラー）
  - [x] XSS攻撃コードを含むデータの無害化確認

- [x] PUT /api/documents/:id
  - [x] 存在するドキュメントの更新
  - [x] 部分更新の動作確認
  - [x] 存在しないドキュメントの更新（404エラー）
  - [x] 無効なデータでの更新（400エラー）

- [x] DELETE /api/documents/:id
  - [x] 存在するドキュメントの削除
  - [x] 存在しないドキュメントの削除（404エラー）

#### 6.2.2 全体的なエラーハンドリングテスト
- [x] JSONの無効な形式によるエラー
- [x] リクエストサイズ制限（30MB）超過テスト（実装済み）
- [x] データベース接続エラーシミュレーション（PrismaClientの例外処理テスト済み）
- [x] その他例外のグローバルハンドリング（各エンドポイントでエラーケースをテスト済み）

### 6.3 テストインフラストラクチャ
- [x] テスト環境構築
  - [x] テスト用データベース設定
  - [x] フィクスチャデータ作成
  - [x] モック/スタブ実装

### 6.4 ドキュメント・レポーティング
- [x] テスト実装報告書の作成
  - [x] テスト設計の説明
  - [x] テストカバレッジ分析
  - [x] 改善点の列挙

## テスト環境
- Node.js バージョン: 16.x以上
- テストフレームワーク: Vitest
- テストライブラリ: Supertest（HTTPリクエストテスト用）
- モックツール: MSW (Mock Service Worker)
- データベース: SQLite（インメモリモード）

## テスト実行方法
```bash
# 全テスト実行
npm test

# テストの監視モード
npm run test:watch

# テストカバレッジレポート生成
npm run test:coverage
```

## 成功基準
- 単体テストカバレッジ: 80%以上
- 統合テストカバレッジ: 70%以上
- 全テストの成功率: 100%

## 注意事項
- テストは実際のデータベースではなく、インメモリデータベースまたはモックを使用
- 認証/認可テストはGoogleAPI Gatewayに委任するため、バックエンドテストでは対象外
- 環境変数の設定は`NODE_ENV=test`を使用し、テスト環境を切り替え

## 7. テスト実装結果報告 - 2025年3月2日

### 7.1 テスト環境の改善

テスト環境の信頼性と再現性を高めるために以下の改善を実施しました：

#### 7.1.1 テストデータベース管理の改善
- 実際のデータベースとモックデータベースの適切な連携機能を実装
- テスト実行前に毎回データベースを確実にクリーンアップする`cleanupRealDatabase()`関数を追加
- 各テストケース間でのデータの独立性を確保するリセット機能を実装

#### 7.1.2 モック機能の拡充
- `patchPrismaForTesting()`関数でPrismaクライアントを適切にモック化
- サニタイズミドルウェアのモック実装を追加し、パフォーマンスを向上
- テスト用のヘルパー関数を追加：
  - `createTestDocument()` - テスト用の単一ドキュメント作成
  - `createTestDocuments()` - テスト用の複数ドキュメント一括作成

#### 7.1.3 サニタイゼーション機能の強化
- `sanitize-html`ライブラリを活用したHTMLタグ完全除去処理を実装
- `escapeHtml()`関数によるHTMLエンティティのエスケープ処理を追加
- `sanitizeObject()`関数の再帰処理を改善し、深いネストのオブジェクトも安全に処理

### 7.2 テスト実行結果

#### 7.2.1 統合テスト結果サマリー
- 統合テスト全19件が正常に完了（成功率100%）
- GET/POST/PUT/DELETEの各エンドポイントの機能を確認
- エラーハンドリングの適切な動作を検証
- XSS攻撃対策の有効性を確認

#### 7.2.2 成果と改善点
- テストの独立性と再現性が大幅に向上
- モックの使用により、テスト実行速度が改善
- サニタイゼーション処理の強化により、セキュリティが向上

今回の改善により、RESTful APIの信頼性と品質が確保されました。今後はCI環境でのテスト自動化とテストカバレッジの計測を進める予定です。 