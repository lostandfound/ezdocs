# テスト計画書

## 概要
本計画書は、EzDocsシステムのRESTful APIのテスト実装に関する詳細計画を示すものです。単体テストと統合テストの両方を含み、APIの機能性、セキュリティ対策、エラーハンドリングを検証します。

## 実施日程
開始予定日: 2025年3月3日

## 6. テスト実装
### 6.1 単体テスト
#### 6.1.1 ミドルウェアテスト
- [x] バリデーションミドルウェア（validate.ts）のテスト
  - [x] 有効なbodyデータの検証
  - [x] 無効なbodyデータの検証と適切なエラーレスポンス確認
  - [x] URLパラメータの検証（有効/無効）
  - [x] クエリパラメータの検証（有効/無効）
  - [x] 複合検証のテスト（body, params, query組み合わせ）

- [x] サニタイズミドルウェア（sanitize.ts）のテスト
  - [x] HTML/スクリプトタグの除去確認
  - [x] ネストされたオブジェクトのサニタイズ
  - [x] 配列内の値のサニタイズ
  - [x] 非文字列データ（数値、真偽値など）の保持確認

- [x] エラーハンドリングミドルウェアのテスト
  - [x] 404エラー（リソース不在）のハンドリング
  - [x] 400エラー（バリデーションエラー）のハンドリング
  - [x] 500エラー（内部エラー）のハンドリング
  - [x] カスタムエラーのハンドリング

#### 6.1.2 スキーマ/バリデーションルールのテスト
- [ ] ドキュメント作成スキーマのテスト
  - [ ] 必須フィールド検証
  - [ ] フィールド型検証
  - [ ] 列挙型制約（ドキュメントタイプなど）

- [ ] ドキュメント更新スキーマのテスト
  - [ ] オプショナルフィールド検証
  - [ ] 部分更新の正確性

- [ ] ページネーションスキーマのテスト
  - [ ] デフォルト値の検証
  - [ ] 境界値テスト（最小値、最大値）

#### 6.1.3 サービス層テスト
- [ ] ドキュメントサービスの単体テスト
  - [ ] 文書の取得（findById, findAll）
  - [ ] 文書の作成
  - [ ] 文書の更新
  - [ ] 文書の削除
  - [ ] ページネーション機能
  - [ ] エラーケースのハンドリング

### 6.2 統合テスト
#### 6.2.1 APIエンドポイントテスト
- [ ] GET /api/documents
  - [ ] 空のリストの取得（初期状態）
  - [ ] 複数ドキュメントの取得
  - [ ] ページネーション動作確認
  - [ ] 並び順の検証

- [ ] GET /api/documents/:id
  - [ ] 存在するドキュメントの取得
  - [ ] 存在しないドキュメントの取得（404エラー）
  - [ ] 無効なID形式での取得（400エラー）

- [ ] POST /api/documents
  - [ ] 有効なデータでの作成
  - [ ] 必須フィールド欠如での作成（400エラー）
  - [ ] 無効な型データでの作成（400エラー）
  - [ ] XSS攻撃コードを含むデータの無害化確認

- [ ] PUT /api/documents/:id
  - [ ] 存在するドキュメントの更新
  - [ ] 部分更新の動作確認
  - [ ] 存在しないドキュメントの更新（404エラー）
  - [ ] 無効なデータでの更新（400エラー）

- [ ] DELETE /api/documents/:id
  - [ ] 存在するドキュメントの削除
  - [ ] 存在しないドキュメントの削除（404エラー）

#### 6.2.2 全体的なエラーハンドリングテスト
- [ ] JSONの無効な形式によるエラー
- [ ] リクエストサイズ制限（30MB）超過テスト
- [ ] データベース接続エラーシミュレーション
- [ ] その他例外のグローバルハンドリング

### 6.3 テストインフラストラクチャ
- [ ] テスト環境構築
  - [ ] テスト用データベース設定
  - [ ] フィクスチャデータ作成
  - [ ] モック/スタブ実装

- [ ] テスト実行自動化
  - [ ] CIパイプラインへの統合
  - [ ] テストカバレッジレポート設定

### 6.4 ドキュメント・レポーティング
- [ ] テスト実装報告書の作成
  - [ ] テスト設計の説明
  - [ ] テストカバレッジ分析
  - [ ] 改善点の列挙

## テスト環境
- Node.js バージョン: 16.x以上
- テストフレームワーク: Vitest
- テストライブラリ: Supertest（HTTPリクエストテスト用）
- モックツール: MSW (Mock Service Worker)
- データベース: SQLite（インメモリモード）

## テスト実行方法
```bash
# 全テスト実行
npm test

# テストの監視モード
npm run test:watch

# テストカバレッジレポート生成
npm run test:coverage
```

## 成功基準
- 単体テストカバレッジ: 80%以上
- 統合テストカバレッジ: 70%以上
- 全テストの成功率: 100%

## 注意事項
- テストは実際のデータベースではなく、インメモリデータベースまたはモックを使用
- 認証/認可テストはGoogleAPI Gatewayに委任するため、バックエンドテストでは対象外
- 環境変数の設定は`NODE_ENV=test`を使用し、テスト環境を切り替え 