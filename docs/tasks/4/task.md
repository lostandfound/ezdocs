# REST API実装タスク（ドキュメントリソース）

## 目的
EzDocsシステムのバックエンドにRESTful APIを実装し、文書リソース（ドキュメント）に対するCRUD操作を提供する。クライアントアプリケーションやサードパーティシステムがEzDocsのデータにアクセスするための標準的なインターフェースを構築する。

## 現状
- バックエンドアプリケーションの基本構造は実装済み
- データベースのスキーマ設計は完了しており、マイグレーションも実装済み
- クラウドストレージの設計と実装は進行中
- REST APIエンドポイントはまだ実装されていない
- 現在はヘルスチェックエンドポイント（/health）のみが実装されている

## 目標
- RESTful設計原則に従った一貫性のあるAPIを実装する
- 文書データに対する完全なCRUD操作を提供する
- 文書リソースについてのみ実装し、関連リソース（著者、ファイル）は後続フェーズで対応
- ページネーション機能を実装する
- API入出力のバリデーションを確実に行う
- API仕様書（OpenAPI）をGoogle API Gatewayの制約を考慮して作成する
- APIのユニットテストを実装する

## タスク一覧

1. [x] API設計の詳細化
   * [x] ドキュメントリソースのエンドポイント設計
   * [x] リクエスト/レスポンス形式の定義
   * [x] エラーハンドリング方針の確立
   * [x] APIのバージョン管理方針の確定
   * [x] ページネーションの実装

2. [x] バリデーション実装
   * [x] リクエストスキーマの定義（Zod）
   * [x] バリデーションミドルウェアの実装
   * [x] エラーレスポンスの統一フォーマット設定
   * [x] データ型変換の実装

3. [x] セキュリティ対策実装
   * [x] XSS対策：入力データのサニタイズ
   * [x] 一般的なWebアタック対策
   * [x] APIリクエスト検証の強化
   * [x] JSONリクエストサイズ制限の設定（30MB）

4. [x] テスト実装
   * [x] 単体テスト
     * [x] バリデーションミドルウェア
     * [x] サニタイズミドルウェア
     * [x] エラーハンドリング
   * [x] 統合テスト
     * [x] エンドポイント
     * [x] エラーケース
   * [x] テスト環境の改善
     * [x] テストデータベースの分離
     * [x] モック機能の強化
     * [x] サニタイゼーション機能の改善

5. [x] ドキュメント作成
   * [x] OpenAPIスペック作成
   * [x] APIの使用方法ドキュメント
   * [x] エラーコードと対応方法

6. [ ] 保留中の機能
   * [ ] レート制限（Google API Gateway対応）
   * [ ] 認証・認可（Google Identity Platform連携）
   * [ ] API鍵管理（Google API Gatewayポリシー）

## 注意事項
- 認証・認可はGoogle Cloud API Gatewayに委任するため、バックエンドでの実装は不要
- OpenAPI仕様書はGoogle API Gatewayの制約を受ける可能性があるため、互換性に注意
- レート制限もAPI Gatewayで実装されるが、バックエンドでの過負荷対策は考慮する

## 保留中の機能
以下の機能は次のフェーズで実装を検討します：

1. **クエリパラメータによるフィルタリング**
   - 例: `GET /api/documents?year=2023&type=paper`

2. **著者(persons)リソースAPI**
   - `GET/POST /api/persons`
   - `GET/PUT/DELETE /api/persons/:id`
   - `GET /api/persons/:id/documents`
   - 文書への著者割り当て機能

3. **ファイルリソースAPI**
   - `GET/POST /api/files`
   - `GET/DELETE /api/files/:id`
   - `GET /api/files/:id/content`
   - 文書へのファイル割り当て機能

4. **高度なAPI機能**
   - 検索API（フルテキスト検索対応）
   - 書誌情報の自動抽出API
   - OCRテキスト抽出API
   - 引用生成API

5. **エラーハンドリングの拡張**
   - 詳細なエラーコード体系の整備
   - 多言語対応のエラーメッセージシステム
   - クライアント向けのエラーハンドリングガイドライン 