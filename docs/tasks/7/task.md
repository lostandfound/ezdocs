# REST API実装（著者リソース）

## 目的
EzDocsシステムのバックエンドにRESTful APIを実装し、著者リソース（persons）に対するCRUD操作を提供する。これにより、文書管理システムにおける著者情報の管理と、文書との関連付けを可能にする。

## 現状
- バックエンドアプリケーションの基本構造は実装済み
- 文書リソース（documents）のREST APIは実装済み
- データベーススキーマは既に実装済み（Person, DocumentAuthorモデル）
- 著者リソースのREST APIエンドポイントはまだ実装されていない

## 目標
- RESTful設計原則に従った一貫性のあるAPIを実装する
- 著者データに対する完全なCRUD操作を提供する
- 文書リソースとの関連付け機能を実装する
- ページネーション機能を実装する
- API入出力のバリデーションを確実に行う
- API仕様書（OpenAPI）をGoogle API Gatewayの制約を考慮して作成する
- APIのユニットテストを実装する

## タスク一覧

- [x] API設計
  - [x] エンドポイント設計
  - [x] リクエスト/レスポンス形式の設計
  - [x] エラーハンドリング方針の決定
  - [x] ページネーションの設計

- [x] バリデーションと例外処理
  - [x] バリデーションスキーマの定義
  - [x] バリデーションルールの実装
  - [x] バリデーションミドルウェアの実装
  - [x] エラーハンドリングミドルウェアの実装

- [x] ルーティングの実装
  - [x] 著者一覧・詳細取得ルートの実装
  - [x] 著者作成・更新・削除ルートの実装
  - [x] 著者-文書関連ルートの実装
  - [x] ミドルウェアの適用

- [x] コントローラーの実装
  - [x] 著者一覧取得コントローラーの実装
  - [x] 著者詳細取得コントローラーの実装
  - [x] 著者作成コントローラーの実装
  - [x] 著者更新コントローラーの実装
  - [x] 著者削除コントローラーの実装
  - [x] 著者-文書関連コントローラーの実装

- [x] サービス層の実装
  - [x] 著者取得サービスの実装
  - [x] 著者作成・更新・削除サービスの実装
  - [x] 著者-文書関連サービスの実装
  - [x] 検索機能の実装
  - [x] ページネーション機能の実装

- [x] データアクセス層の実装
  - [x] Prismaモデルの拡張
  - [x] リポジトリパターンの適用
  - [x] トランザクション処理の実装

- [x] セキュリティ対策
  - [x] 入力サニタイズの実装
  - [x] CORS設定の確認
  - [x] レート制限の実装
  - [x] 認証・認可の確認

- [x] テスト計画書の作成
  - [x] テスト範囲の定義
  - [x] テストケースの洗い出し
  - [x] テスト環境の準備

- [x] 単体テスト
  - [x] バリデーションスキーマのテスト
  - [x] サービス層のテスト
  - [x] コントローラーのテスト

- [x] 統合テスト
  - [x] エンドポイントのテスト
  - [x] エラーケースのテスト
  - [x] 文書との関連付けテスト

- [ ] ドキュメント作成
  - [ ] API仕様書の更新
  - [ ] エンドポイントの使用例の追加
  - [ ] エラーコードの説明

- [ ] パフォーマンス最適化
  - [ ] クエリの最適化
  - [ ] インデックスの確認
  - [ ] キャッシュ戦略の検討

- [ ] デプロイ準備
  - [ ] 環境変数の設定
  - [ ] ログ出力の確認
  - [ ] 本番環境での動作確認

## 注意事項
- 認証・認可はGoogle Cloud API Gatewayに委任するため、バックエンドでの実装は不要
- OpenAPI仕様書はGoogle API Gatewayの制約を受ける可能性があるため、互換性に注意
- 文書リソースとの関連付けは、既存のDocumentAuthorモデルを使用する
- 著者情報には機密性の高い個人情報が含まれる可能性があるため、適切なデータ保護対策を実施する

## データモデル

### Person（既存のPrismaモデル）
```typescript
interface Person {
  id: string;          // UUID
  last_name: string;   // 姓
  first_name?: string; // 名（オプション）
  created_at: Date;    // 作成日時
  updated_at: Date;    // 更新日時
  documents: DocumentAuthor[]; // 関連文書（中間テーブル経由）
}
```

### DocumentAuthor（既存のPrismaモデル）
```typescript
interface DocumentAuthor {
  document_id: string; // 文書ID
  person_id: string;   // 著者ID
  order: number;       // 著者順序
  document: Document;  // 文書への参照
  person: Person;      // 著者への参照
}
```

## APIエンドポイント仕様

### GET /api/persons
著者一覧を取得します。

**クエリパラメータ**
- `page`: ページ番号（デフォルト: 1）
- `limit`: 1ページあたりの件数（デフォルト: 20, 最大: 100）
- `q`: 検索キーワード（姓名で部分一致検索）

**レスポンス例**
```json
{
  "data": [
    {
      "id": "uuid-1",
      "first_name": "太郎",
      "last_name": "山田",
      "created_at": "2025-03-03T12:34:56Z",
      "updated_at": "2025-03-03T12:34:56Z"
    }
  ],
  "pagination": {
    "total": 100,
    "page": 1,
    "limit": 20,
    "pages": 5
  }
}
```

### POST /api/persons
新しい著者を作成します。

**リクエストボディ**
```json
{
  "first_name": "太郎",
  "last_name": "山田"
}
```

### GET /api/persons/:id
指定されたIDの著者詳細を取得します。

### PUT /api/persons/:id
指定されたIDの著者情報を更新します。

### DELETE /api/persons/:id
指定されたIDの著者を削除します。

### GET /api/persons/:id/documents
指定された著者が関連する文書一覧を取得します。
