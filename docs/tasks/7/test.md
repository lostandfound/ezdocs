# 著者リソースAPI テスト計画書

## 1. テスト目的

このテスト計画は、EzDocsシステムの著者リソース（persons）に対するREST APIの機能検証を目的としています。テストを通じて以下を確認します：

- 各エンドポイントが仕様通りに動作すること
- バリデーションが適切に機能すること
- エラー処理が適切に行われること
- 文書リソースとの関連付けが正しく機能すること
- ページネーションが正しく機能すること

## 2. テスト環境

- **テスト環境**: 開発環境（ローカル）
- **データベース**: SQLite（テスト用）
- **テストフレームワーク**: Vitest
- **HTTPクライアント**: supertest
- **テストデータ**: 事前に用意したフィクスチャデータ

## 3. テスト項目

### 3.1 単体テスト

#### 3.1.1 バリデーションスキーマのテスト

- [x] `createPersonSchema`
  - [x] 必須フィールド（`last_name`）が存在しない場合にエラーとなること
  - [x] `last_name`が空文字列の場合にエラーとなること
  - [x] 有効なデータが正しく検証されること
  - [x] `first_name`がオプショナルであること

- [x] `updatePersonSchema`
  - [x] 部分的な更新（一部フィールドのみ）が許可されること
  - [x] 空のオブジェクトが許可されること
  - [x] 無効なフィールド値がエラーとなること

- [x] `documentAuthorSchema`
  - [x] 必須フィールド（`document_id`, `order`）が存在しない場合にエラーとなること
  - [x] `document_id`が無効なUUID形式の場合にエラーとなること
  - [x] `order`が1未満の場合にエラーとなること
  - [x] 有効なデータが正しく検証されること

#### 3.1.2 サービス層のテスト

- [x] `findPersons`
  - [x] ページネーションが正しく機能すること
  - [x] 検索クエリが正しく機能すること
  - [x] 結果が正しい形式で返されること

- [x] `findPersonById`
  - [x] 存在するIDの場合に正しい著者データが返されること
  - [x] 存在しないIDの場合に`null`が返されること

- [x] `createPerson`
  - [x] 有効なデータで著者が作成されること
  - [x] 作成された著者が正しい形式で返されること

- [x] `updatePerson`
  - [x] 存在するIDの場合に著者データが更新されること
  - [x] 存在しないIDの場合に適切なエラーが発生すること
  - [x] 部分的な更新が正しく機能すること

- [x] `deletePerson`
  - [x] 存在するIDの場合に著者が削除されること
  - [x] 存在しないIDの場合に適切なエラーが発生すること

- [x] `findPersonDocuments`
  - [x] 著者に関連する文書が正しく取得されること
  - [x] ページネーションが正しく機能すること
  - [x] 存在しない著者IDの場合に適切なエラーが発生すること

- [x] `associatePersonWithDocument`
  - [x] 著者と文書が正しく関連付けられること
  - [x] 既に関連付けられている場合に適切なエラーが発生すること
  - [x] 存在しない著者または文書IDの場合に適切なエラーが発生すること

- [x] `dissociatePersonFromDocument`
  - [x] 著者と文書の関連付けが正しく解除されること
  - [x] 関連付けが存在しない場合に適切なエラーが発生すること

#### 3.1.3 コントローラーのテスト

- [x] `getPersons`
  - [x] 正しいステータスコード（200）が返されること
  - [x] レスポンスが正しい形式（データ配列とページネーション情報）であること
  - [x] クエリパラメータが正しく処理されること

- [x] `getPersonById`
  - [x] 存在するIDの場合に正しいステータスコード（200）が返されること
  - [x] 存在しないIDの場合に正しいステータスコード（404）が返されること
  - [x] レスポンスが正しい形式であること

- [x] `createPerson`
  - [x] 有効なデータの場合に正しいステータスコード（201）が返されること
  - [x] 無効なデータの場合に正しいステータスコード（400）が返されること
  - [x] レスポンスが正しい形式であること

- [x] `updatePerson`
  - [x] 存在するIDと有効なデータの場合に正しいステータスコード（200）が返されること
  - [x] 存在しないIDの場合に正しいステータスコード（404）が返されること
  - [x] 無効なデータの場合に正しいステータスコード（400）が返されること
  - [x] レスポンスが正しい形式であること

- [x] `deletePerson`
  - [x] 存在するIDの場合に正しいステータスコード（204）が返されること
  - [x] 存在しないIDの場合に正しいステータスコード（404）が返されること

- [x] `getPersonDocuments`
  - [x] 存在する著者IDの場合に正しいステータスコード（200）が返されること
  - [x] 存在しない著者IDの場合に正しいステータスコード（404）が返されること
  - [x] レスポンスが正しい形式（文書データ配列とページネーション情報）であること

- [x] `associateDocument`
  - [x] 有効なデータの場合に正しいステータスコード（201）が返されること
  - [x] 無効なデータの場合に正しいステータスコード（400）が返されること
  - [x] 存在しない著者または文書IDの場合に正しいステータスコード（404）が返されること
  - [x] レスポンスが正しい形式であること

- [x] `dissociateDocument`
  - [x] 存在する関連付けの場合に正しいステータスコード（204）が返されること
  - [x] 存在しない関連付けの場合に正しいステータスコード（404）が返されること

### 3.2 統合テスト

#### 3.2.1 エンドポイントのテスト

- [x] `GET /api/persons`
  - [x] ステータスコード200が返されること
  - [x] レスポンスが正しい形式であること
  - [x] ページネーションが機能すること
  - [x] 検索クエリが機能すること

- [x] `POST /api/persons`
  - [x] 有効なデータでステータスコード201が返されること
  - [x] 無効なデータでステータスコード400が返されること
  - [x] 作成された著者が正しく返されること

- [x] `GET /api/persons/:id`
  - [x] 存在するIDでステータスコード200が返されること
  - [x] 存在しないIDでステータスコード404が返されること
  - [x] 無効なIDでステータスコード400が返されること

- [x] `PUT /api/persons/:id`
  - [x] 存在するIDと有効なデータでステータスコード200が返されること
  - [x] 存在しないIDでステータスコード404が返されること
  - [x] 無効なデータでステータスコード400が返されること
  - [x] 更新された著者が正しく返されること

- [x] `DELETE /api/persons/:id`
  - [x] 存在するIDでステータスコード204が返されること
  - [x] 存在しないIDでステータスコード404が返されること
  - [x] 無効なIDでステータスコード400が返されること
  - [x] 削除後にGETリクエストで404が返されること

- [x] `GET /api/persons/:id/documents`
  - [x] 存在する著者IDでステータスコード200が返されること
  - [x] 存在しない著者IDでステータスコード404が返されること
  - [x] ページネーションが機能すること

- [x] `POST /api/persons/:id/documents`
  - [x] 有効なデータでステータスコード201が返されること
  - [x] 無効なデータでステータスコード400が返されること
  - [x] 存在しない著者または文書IDでステータスコード404が返されること
  - [x] 関連付けが正しく作成されること

- [x] `DELETE /api/persons/:id/documents/:document_id`
  - [x] 存在する関連付けでステータスコード204が返されること
  - [x] 存在しない関連付けでステータスコード404が返されること
  - [x] 無効なIDでステータスコード400が返されること
  - [x] 関連付けが正しく削除されること

#### 3.2.2 エラーケースのテスト

- [x] バリデーションエラー
  - [x] 必須フィールドが欠けている場合に適切なエラーメッセージが返されること
  - [x] 無効な形式のデータに対して適切なエラーメッセージが返されること

- [x] リソース未検出エラー
  - [x] 存在しないリソースに対して適切なエラーメッセージが返されること

- [x] サーバーエラー
  - [x] データベースエラーなどの内部エラーが適切に処理されること

#### 3.2.3 文書との関連付けテスト

- [x] 著者と文書の関連付け
  - [x] 著者に複数の文書を関連付けられること
  - [x] 同じ文書に複数の著者を関連付けられること
  - [x] 著者順序（order）が正しく設定されること

- [x] 著者と文書の関連付け解除
  - [x] 特定の著者と文書の関連付けのみが解除されること
  - [x] 他の関連付けは影響を受けないこと

## 4. テスト実行手順

### 4.1 テスト準備

1. テスト用データベースのセットアップ
   ```bash
   npm run test:setup
   ```

2. テストデータ（フィクスチャ）の準備
   ```bash
   npm run test:seed
   ```

### 4.2 単体テスト実行

```bash
npm run test:unit
```

### 4.3 統合テスト実行

```bash
npm run test:integration
```

### 4.4 全テスト実行

```bash
npm run test
```

## 5. テスト結果の評価

- すべてのテストが成功すること
- コードカバレッジが80%以上であること
- エラーケースが適切に処理されていること
- パフォーマンスが許容範囲内であること（レスポンスタイムが500ms以内）

## 6. 注意事項

- テスト実行前に開発環境のデータベースをバックアップすること
- テストはテスト用データベースで実行し、本番データに影響を与えないようにすること
- APIの変更があった場合は、テスト計画も更新すること 