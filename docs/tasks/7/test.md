# 著者リソースAPI テスト計画書

## 1. テスト目的

このテスト計画は、EzDocsシステムの著者リソース（persons）に対するREST APIの機能検証を目的としています。テストを通じて以下を確認します：

- 各エンドポイントが仕様通りに動作すること
- バリデーションが適切に機能すること
- エラー処理が適切に行われること
- 文書リソースとの関連付けが正しく機能すること
- ページネーションが正しく機能すること

## 2. テスト環境

- **テスト環境**: 開発環境（ローカル）
- **データベース**: SQLite（テスト用）
- **テストフレームワーク**: Vitest
- **HTTPクライアント**: supertest
- **テストデータ**: 事前に用意したフィクスチャデータ

## 3. テスト項目

### 3.1 単体テスト

#### 3.1.1 バリデーションスキーマのテスト

- [ ] `createPersonSchema`
  - [ ] 必須フィールド（`last_name`）が存在しない場合にエラーとなること
  - [ ] `last_name`が空文字列の場合にエラーとなること
  - [ ] 有効なデータが正しく検証されること
  - [ ] `first_name`がオプショナルであること

- [ ] `updatePersonSchema`
  - [ ] 部分的な更新（一部フィールドのみ）が許可されること
  - [ ] 空のオブジェクトが許可されること
  - [ ] 無効なフィールド値がエラーとなること

- [ ] `documentAuthorSchema`
  - [ ] 必須フィールド（`document_id`, `order`）が存在しない場合にエラーとなること
  - [ ] `document_id`が無効なUUID形式の場合にエラーとなること
  - [ ] `order`が1未満の場合にエラーとなること
  - [ ] 有効なデータが正しく検証されること

#### 3.1.2 サービス層のテスト

- [ ] `findPersons`
  - [ ] ページネーションが正しく機能すること
  - [ ] 検索クエリが正しく機能すること
  - [ ] 結果が正しい形式で返されること

- [ ] `findPersonById`
  - [ ] 存在するIDの場合に正しい著者データが返されること
  - [ ] 存在しないIDの場合に`null`が返されること

- [ ] `createPerson`
  - [ ] 有効なデータで著者が作成されること
  - [ ] 作成された著者が正しい形式で返されること

- [ ] `updatePerson`
  - [ ] 存在するIDの場合に著者データが更新されること
  - [ ] 存在しないIDの場合に適切なエラーが発生すること
  - [ ] 部分的な更新が正しく機能すること

- [ ] `deletePerson`
  - [ ] 存在するIDの場合に著者が削除されること
  - [ ] 存在しないIDの場合に適切なエラーが発生すること

- [ ] `findPersonDocuments`
  - [ ] 著者に関連する文書が正しく取得されること
  - [ ] ページネーションが正しく機能すること
  - [ ] 存在しない著者IDの場合に適切なエラーが発生すること

- [ ] `associatePersonWithDocument`
  - [ ] 著者と文書が正しく関連付けられること
  - [ ] 既に関連付けられている場合に適切なエラーが発生すること
  - [ ] 存在しない著者または文書IDの場合に適切なエラーが発生すること

- [ ] `dissociatePersonFromDocument`
  - [ ] 著者と文書の関連付けが正しく解除されること
  - [ ] 関連付けが存在しない場合に適切なエラーが発生すること

#### 3.1.3 コントローラーのテスト

- [ ] `getPersons`
  - [ ] 正しいステータスコード（200）が返されること
  - [ ] レスポンスが正しい形式（データ配列とページネーション情報）であること
  - [ ] クエリパラメータが正しく処理されること

- [ ] `getPersonById`
  - [ ] 存在するIDの場合に正しいステータスコード（200）が返されること
  - [ ] 存在しないIDの場合に正しいステータスコード（404）が返されること
  - [ ] レスポンスが正しい形式であること

- [ ] `createPerson`
  - [ ] 有効なデータの場合に正しいステータスコード（201）が返されること
  - [ ] 無効なデータの場合に正しいステータスコード（400）が返されること
  - [ ] レスポンスが正しい形式であること

- [ ] `updatePerson`
  - [ ] 存在するIDと有効なデータの場合に正しいステータスコード（200）が返されること
  - [ ] 存在しないIDの場合に正しいステータスコード（404）が返されること
  - [ ] 無効なデータの場合に正しいステータスコード（400）が返されること
  - [ ] レスポンスが正しい形式であること

- [ ] `deletePerson`
  - [ ] 存在するIDの場合に正しいステータスコード（204）が返されること
  - [ ] 存在しないIDの場合に正しいステータスコード（404）が返されること

- [ ] `getPersonDocuments`
  - [ ] 存在する著者IDの場合に正しいステータスコード（200）が返されること
  - [ ] 存在しない著者IDの場合に正しいステータスコード（404）が返されること
  - [ ] レスポンスが正しい形式（文書データ配列とページネーション情報）であること

- [ ] `associateDocument`
  - [ ] 有効なデータの場合に正しいステータスコード（201）が返されること
  - [ ] 無効なデータの場合に正しいステータスコード（400）が返されること
  - [ ] 存在しない著者または文書IDの場合に正しいステータスコード（404）が返されること
  - [ ] レスポンスが正しい形式であること

- [ ] `dissociateDocument`
  - [ ] 存在する関連付けの場合に正しいステータスコード（204）が返されること
  - [ ] 存在しない関連付けの場合に正しいステータスコード（404）が返されること

### 3.2 統合テスト

#### 3.2.1 エンドポイントのテスト

- [ ] `GET /api/persons`
  - [ ] ステータスコード200が返されること
  - [ ] レスポンスが正しい形式であること
  - [ ] ページネーションが機能すること
  - [ ] 検索クエリが機能すること

- [ ] `POST /api/persons`
  - [ ] 有効なデータでステータスコード201が返されること
  - [ ] 無効なデータでステータスコード400が返されること
  - [ ] 作成された著者が正しく返されること

- [ ] `GET /api/persons/:id`
  - [ ] 存在するIDでステータスコード200が返されること
  - [ ] 存在しないIDでステータスコード404が返されること
  - [ ] 無効なIDでステータスコード400が返されること

- [ ] `PUT /api/persons/:id`
  - [ ] 存在するIDと有効なデータでステータスコード200が返されること
  - [ ] 存在しないIDでステータスコード404が返されること
  - [ ] 無効なデータでステータスコード400が返されること
  - [ ] 更新された著者が正しく返されること

- [ ] `DELETE /api/persons/:id`
  - [ ] 存在するIDでステータスコード204が返されること
  - [ ] 存在しないIDでステータスコード404が返されること
  - [ ] 無効なIDでステータスコード400が返されること
  - [ ] 削除後にGETリクエストで404が返されること

- [ ] `GET /api/persons/:id/documents`
  - [ ] 存在する著者IDでステータスコード200が返されること
  - [ ] 存在しない著者IDでステータスコード404が返されること
  - [ ] ページネーションが機能すること

- [ ] `POST /api/persons/:id/documents`
  - [ ] 有効なデータでステータスコード201が返されること
  - [ ] 無効なデータでステータスコード400が返されること
  - [ ] 存在しない著者または文書IDでステータスコード404が返されること
  - [ ] 関連付けが正しく作成されること

- [ ] `DELETE /api/persons/:id/documents/:document_id`
  - [ ] 存在する関連付けでステータスコード204が返されること
  - [ ] 存在しない関連付けでステータスコード404が返されること
  - [ ] 無効なIDでステータスコード400が返されること
  - [ ] 関連付けが正しく削除されること

#### 3.2.2 エラーケースのテスト

- [ ] バリデーションエラー
  - [ ] 必須フィールドが欠けている場合に適切なエラーメッセージが返されること
  - [ ] 無効な形式のデータに対して適切なエラーメッセージが返されること

- [ ] リソース未検出エラー
  - [ ] 存在しないリソースに対して適切なエラーメッセージが返されること

- [ ] サーバーエラー
  - [ ] データベースエラーなどの内部エラーが適切に処理されること

#### 3.2.3 文書との関連付けテスト

- [ ] 著者と文書の関連付け
  - [ ] 著者に複数の文書を関連付けられること
  - [ ] 同じ文書に複数の著者を関連付けられること
  - [ ] 著者順序（order）が正しく設定されること

- [ ] 著者と文書の関連付け解除
  - [ ] 特定の著者と文書の関連付けのみが解除されること
  - [ ] 他の関連付けは影響を受けないこと

## 4. テスト実行手順

### 4.1 テスト準備

1. テスト用データベースのセットアップ
   ```bash
   npm run test:setup
   ```

2. テストデータ（フィクスチャ）の準備
   ```bash
   npm run test:seed
   ```

### 4.2 単体テスト実行

```bash
npm run test:unit
```

### 4.3 統合テスト実行

```bash
npm run test:integration
```

### 4.4 全テスト実行

```bash
npm run test
```

## 5. テスト結果の評価

- すべてのテストが成功すること
- コードカバレッジが80%以上であること
- エラーケースが適切に処理されていること
- パフォーマンスが許容範囲内であること（レスポンスタイムが500ms以内）

## 6. 注意事項

- テスト実行前に開発環境のデータベースをバックアップすること
- テストはテスト用データベースで実行し、本番データに影響を与えないようにすること
- APIの変更があった場合は、テスト計画も更新すること 